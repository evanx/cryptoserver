{"version":3,"sources":["../lib/SupervisorStarter.js"],"names":[],"mappings":"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","file":"SupervisorStarter.js","sourcesContent":["\n// messages\n\nvar Messages = require('./SupervisorStarter.messages.js');\n\n// create context for Supervisor and components\n\n// globals\n\nfunction assignLibs(g) {\n   g.assert = require('assert');\n   g.bluebird = require('bluebird');\n   g.bunyan = require('bunyan');\n   g.crypto = require('crypto');\n   g.fs = require('fs');\n   g.http = require('http');\n   g.lodash = require('lodash');\n   g.os = require('os');\n   g.redisLib = require('redis');\n}\n\nfunction assignErrors(g) {\n   g.ApplicationError = function() {\n      this.constructor.prototype.__proto__ = Error.prototype;\n      Error.captureStackTrace(this, this.constructor);\n      this.name = 'ApplicationError';\n      var args = [].slice.call(arguments);\n      if (args.length === 1) {\n         this.message = args[0].toString();\n      } else {\n         this.message = args.toString();\n      }\n   };\n   g.ValidationError = function() {\n      this.constructor.prototype.__proto__ = Error.prototype;\n      Error.captureStackTrace(this, this.constructor);\n      this.name = 'ValidationError';\n      var args = [].slice.call(arguments);\n      if (args.length === 1) {\n         this.message = args[0].toString();\n      } else {\n         this.message = args.toString();\n      }\n   };\n}\n\nassignLibs(global);\nassignErrors(global);\n\n// logging\n\nconst config = {\n   loggerName: 'supervisor',\n   loggerLevel: 'info'\n};\nif (process.env.loggerLevel) {\n   config.loggerLevel = process.env.loggerLevel;\n} else if (process.env.NODE_ENV === 'development') {\n   config.loggerLevel = 'debug';\n}\n\nglobal.loggerLevel = config.loggerLevel;\nif (process.env.loggerUrl) {\n   global.loggerUrl = process.env.loggerUrl;\n}\n\nconst logger = global.bunyan.createLogger({name: config.loggerName, level: config.loggerLevel})\n\n// redis\n\nbluebird.promisifyAll(redisLib.RedisClient.prototype);\nbluebird.promisifyAll(redisLib.Multi.prototype);\nredisLib.RedisClient.prototype.multiExecAsync = function(fn) {\n   var multi = this.multi();\n   fn(multi);\n   return multi.execAsync();\n};\n\n// dependencies\n\nfunction assignDeps(g) {\n   g.Loggers = require('./Loggers');\n   g.Asserts = require('./Asserts');\n   g.ClassPreprocessor = require('./ClassPreprocessor');\n   g.CsonFiles = require('./CsonFiles');\n   g.Files = require('./Files');\n   g.Metas = require('./Metas');\n   g.Millis = require('./Millis');\n   g.Promises = require('./Promises');\n   g.Requests = require('./Requests');\n   g.Strings = require('./Strings');\n   g.Values = require('./Values');\n}\n\nassignDeps(global);\n\n// supervisor configuration\n\nfunction getSupervisorMeta() {\n   logger.debug('getSupervisorMeta');\n   const componentsConfig = getComponentsConfig();\n   logger.debug('config.spec', componentsConfig.spec);\n   const componentsMeta = CsonFiles.readFileSync('./components.cson');\n   logger.debug('components.spec', componentsMeta.spec);\n   if (!Metas.isSpecType(componentsMeta, 'components')) {\n      throw {message: 'components.cson spec: ' + componentsMeta.spec};\n   }\n   Object.assign(config, {\n      availableComponents: componentsMeta.components,\n      components: componentsConfig.components\n   });\n   return Object.assign(CsonFiles.readFileSync('./lib/Supervisor.cson'), {config: config});\n}\n\nfunction getComponentsConfig() {\n   if (!process.env.configModule) {\n      throw Messages.missingConfigModule();\n   }\n   logger.info('env.configModule', process.env.configModule);\n   const config = require('.' + process.env.configModule);\n   Object.keys(config).forEach(name => {\n      const componentConfig = config[name];\n      Object.keys(componentConfig).forEach(key => {\n         const envKey = name + '_' + key;\n         if (process.env[envKey]) {\n            componentConfig[key] = process.env[envKey];\n         }\n      });\n   });\n   return config;\n}\n\n// supervisor instance\n\nasync function createSupervisor(supervisorMeta) {\n   logger.debug('createSupervisor', supervisorMeta);\n   if (/\\Wicp\\W/.test(supervisorMeta.spec)) { // TODO babel class transform, rather than fragile regex transformation\n      logger.debug('createSupervisor', supervisorMeta.spec);\n      await ClassPreprocessor.buildSync('./lib/Supervisor.js', [\n         'logger', 'context', 'config'\n      ].concat(Object.keys(supervisorMeta.state)));\n   }\n   const Supervisor = require('../build/Supervisor').default;\n   return new Supervisor();\n}\n\nexport async function startSupervisor() {\n   logger.debug('startSupervisor');\n   const supervisorMeta = getSupervisorMeta();\n   logger.debug('supervisor.spec', supervisorMeta.spec);\n   logger.debug('supervisor config', JSON.stringify(supervisorMeta.config, null, 3));\n   const supervisor = await createSupervisor(supervisorMeta);\n   assert(lodash.isFunction(supervisor.init), 'supervisor.init');\n   Object.assign(supervisor, Object.assign({logger: logger, config: supervisorMeta.config}, supervisorMeta.state));\n   try {\n      await supervisor.init();\n      logger.info('started pid', process.pid);\n      process.on('SIGTERM', function() {\n         logger.info('SIGTERM')\n         supervisor.end();\n      });\n   } catch(err) {\n      if (err.errno) {\n         logger.error({err: err.message, errno: err.errno});\n      } else if (err.code) {\n         logger.error({err: err.message, code: err.code});\n      } else if (!err.name) {\n         logger.error(err);\n      } else if (lodash.includes(['TypeError'], err.name)) {\n         logger.error(err);\n      } else if (lodash.includes(['ValidationError', 'ApplicationError', 'AssertionError'], err.name)) {\n         logger.error(err.message);\n      } else {\n         logger.error(err);\n      }\n      supervisor.end();\n   }\n}\n"]}